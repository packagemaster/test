Backport of:

From b527589d1fb15586fc92a299261180489bdc6220 Mon Sep 17 00:00:00 2001
From: Paolo Bonzini <pbonzini@redhat.com>
Date: Tue, 12 Dec 2017 16:23:41 +0100
Subject: [PATCH] qemu: capabilities: force update if the microcode version
 does not match

A microcode update can cause the CPUID bits to change; an example
from the past was the update that disabled TSX on several Haswell
and Broadwell machines.

Therefore, place microcode version in the virQEMUCaps struct and
XML, and rebuild the cache if the versions do not match.

Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
---
 src/qemu/qemu_capabilities.c                       | 40 +++++++++++++++++++++-
 src/qemu/qemu_capabilities.h                       |  6 ++--
 src/qemu/qemu_capspriv.h                           |  5 +++
 src/qemu/qemu_driver.c                             |  9 ++++-
 tests/qemucapabilitiesdata/caps_1.2.2.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_1.3.1.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_1.4.2.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_1.5.3.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_1.6.0.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_1.7.0.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_2.1.1.x86_64.xml   |  1 +
 .../caps_2.10.0-gicv2.aarch64.xml                  |  1 +
 .../caps_2.10.0-gicv3.aarch64.xml                  |  1 +
 tests/qemucapabilitiesdata/caps_2.10.0.ppc64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_2.10.0.s390x.xml   |  1 +
 tests/qemucapabilitiesdata/caps_2.10.0.x86_64.xml  |  1 +
 tests/qemucapabilitiesdata/caps_2.4.0.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_2.5.0.x86_64.xml   |  1 +
 .../caps_2.6.0-gicv2.aarch64.xml                   |  1 +
 .../caps_2.6.0-gicv3.aarch64.xml                   |  1 +
 tests/qemucapabilitiesdata/caps_2.6.0.ppc64.xml    |  1 +
 tests/qemucapabilitiesdata/caps_2.6.0.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_2.7.0.s390x.xml    |  1 +
 tests/qemucapabilitiesdata/caps_2.7.0.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_2.8.0.s390x.xml    |  1 +
 tests/qemucapabilitiesdata/caps_2.8.0.x86_64.xml   |  1 +
 tests/qemucapabilitiesdata/caps_2.9.0.ppc64.xml    |  1 +
 tests/qemucapabilitiesdata/caps_2.9.0.s390x.xml    |  1 +
 tests/qemucapabilitiesdata/caps_2.9.0.x86_64.xml   |  1 +
 tests/qemucapabilitiestest.c                       | 14 +++++---
 tests/qemucapsprobe.c                              |  2 +-
 tests/testutilsqemu.c                              |  2 +-
 32 files changed, 93 insertions(+), 10 deletions(-)

Index: libvirt-3.6.0/src/qemu/qemu_capabilities.c
===================================================================
--- libvirt-3.6.0.orig/src/qemu/qemu_capabilities.c	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/src/qemu/qemu_capabilities.c	2018-01-25 09:24:55.993068367 -0500
@@ -487,6 +487,7 @@ struct _virQEMUCaps {
     unsigned int version;
     unsigned int kvmVersion;
     unsigned int libvirtVersion;
+    unsigned int microcodeVersion;
     char *package;
 
     virArch arch;
@@ -2286,6 +2287,7 @@ virQEMUCapsPtr virQEMUCapsNewCopy(virQEM
 
     ret->version = qemuCaps->version;
     ret->kvmVersion = qemuCaps->kvmVersion;
+    ret->microcodeVersion = qemuCaps->microcodeVersion;
 
     if (VIR_STRDUP(ret->package, qemuCaps->package) < 0)
         goto error;
@@ -3784,6 +3786,7 @@ struct _virQEMUCapsCachePriv {
     uid_t runUid;
     gid_t runGid;
     virArch hostArch;
+    unsigned int microcodeVersion;
 };
 typedef struct _virQEMUCapsCachePriv virQEMUCapsCachePriv;
 typedef virQEMUCapsCachePriv *virQEMUCapsCachePrivPtr;
@@ -3906,6 +3909,13 @@ virQEMUCapsLoadCache(virArch hostArch,
         goto cleanup;
     }
 
+    if (virXPathUInt("string(./microcodeVersion)", ctxt,
+                     &qemuCaps->microcodeVersion) < 0) {
+        virReportError(VIR_ERR_INTERNAL_ERROR, "%s",
+                       _("missing microcode version in QEMU capabilities cache"));
+        goto cleanup;
+    }
+
     if (virXPathBoolean("boolean(./package)", ctxt) > 0) {
         qemuCaps->package = virXPathString("string(./package)", ctxt);
         if (!qemuCaps->package &&
@@ -4170,6 +4180,9 @@ virQEMUCapsFormatCache(virQEMUCapsPtr qe
     virBufferAsprintf(&buf, "<kvmVersion>%d</kvmVersion>\n",
                       qemuCaps->kvmVersion);
 
+    virBufferAsprintf(&buf, "<microcodeVersion>%u</microcodeVersion>\n",
+                      qemuCaps->microcodeVersion);
+
     if (qemuCaps->package)
         virBufferAsprintf(&buf, "<package>%s</package>\n",
                           qemuCaps->package);
@@ -4311,6 +4324,16 @@ virQEMUCapsIsValid(void *data,
         return false;
     }
 
+    if (virQEMUCapsGet(qemuCaps, QEMU_CAPS_KVM) &&
+        priv->microcodeVersion != qemuCaps->microcodeVersion) {
+        VIR_DEBUG("Outdated capabilities for '%s': microcode version changed "
+                  "(%u vs %u)",
+                  qemuCaps->binary,
+                  priv->microcodeVersion,
+                  qemuCaps->microcodeVersion);
+        return false;
+    }
+
     return true;
 }
 
@@ -5126,6 +5149,7 @@ virQEMUCapsNewForBinaryInternal(virArch
                                 const char *libDir,
                                 uid_t runUid,
                                 gid_t runGid,
+                                unsigned int microcodeVersion,
                                 bool qmpOnly)
 {
     virQEMUCapsPtr qemuCaps;
@@ -5182,6 +5206,9 @@ virQEMUCapsNewForBinaryInternal(virArch
     virQEMUCapsInitHostCPUModel(qemuCaps, hostArch, VIR_DOMAIN_VIRT_KVM);
     virQEMUCapsInitHostCPUModel(qemuCaps, hostArch, VIR_DOMAIN_VIRT_QEMU);
 
+    if (virQEMUCapsGet(qemuCaps, QEMU_CAPS_KVM))
+        qemuCaps->microcodeVersion = microcodeVersion;
+
  cleanup:
     VIR_FREE(qmperr);
     return qemuCaps;
@@ -5203,6 +5230,7 @@ virQEMUCapsNewData(const char *binary,
                                            priv->libDir,
                                            priv->runUid,
                                            priv->runGid,
+                                           priv->microcodeVersion,
                                            false);
 }
 
@@ -5285,7 +5313,8 @@ virFileCachePtr
 virQEMUCapsCacheNew(const char *libDir,
                     const char *cacheDir,
                     uid_t runUid,
-                    gid_t runGid)
+                    gid_t runGid,
+                    unsigned int microcodeVersion)
 {
     char *capsCacheDir = NULL;
     virFileCachePtr cache = NULL;
@@ -5308,6 +5337,7 @@ virQEMUCapsCacheNew(const char *libDir,
 
     priv->runUid = runUid;
     priv->runGid = runGid;
+    priv->microcodeVersion = microcodeVersion;
 
  cleanup:
     VIR_FREE(capsCacheDir);
@@ -5781,3 +5811,11 @@ virQEMUCapsFillDomainCaps(virCapsPtr cap
         return -1;
     return 0;
 }
+
+
+void
+virQEMUCapsSetMicrocodeVersion(virQEMUCapsPtr qemuCaps,
+                               unsigned int microcodeVersion)
+{
+    qemuCaps->microcodeVersion = microcodeVersion;
+}
Index: libvirt-3.6.0/src/qemu/qemu_capabilities.h
===================================================================
--- libvirt-3.6.0.orig/src/qemu/qemu_capabilities.h	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/src/qemu/qemu_capabilities.h	2018-01-25 09:24:55.993068367 -0500
@@ -501,8 +501,10 @@ void virQEMUCapsFilterByMachineType(virQ
                                     const char *machineType);
 
 virFileCachePtr virQEMUCapsCacheNew(const char *libDir,
-                                        const char *cacheDir,
-                                        uid_t uid, gid_t gid);
+                                    const char *cacheDir,
+                                    uid_t uid,
+                                    gid_t gid,
+                                    unsigned int microcodeVersion);
 virQEMUCapsPtr virQEMUCapsCacheLookup(virFileCachePtr cache,
                                       const char *binary);
 virQEMUCapsPtr virQEMUCapsCacheLookupCopy(virFileCachePtr cache,
Index: libvirt-3.6.0/src/qemu/qemu_capspriv.h
===================================================================
--- libvirt-3.6.0.orig/src/qemu/qemu_capspriv.h	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/src/qemu/qemu_capspriv.h	2018-01-25 09:24:55.993068367 -0500
@@ -36,6 +36,7 @@ virQEMUCapsNewForBinaryInternal(virArch
                                 const char *libDir,
                                 uid_t runUid,
                                 gid_t runGid,
+                                unsigned int microcodeVersion,
                                 bool qmpOnly);
 
 int virQEMUCapsLoadCache(virArch hostArch,
@@ -101,4 +102,8 @@ virQEMUCapsParseHelpStr(const char *qemu
 int
 virQEMUCapsParseDeviceStr(virQEMUCapsPtr qemuCaps,
                           const char *str);
+
+void
+virQEMUCapsSetMicrocodeVersion(virQEMUCapsPtr qemuCaps,
+                               unsigned int microcodeVersion);
 #endif
Index: libvirt-3.6.0/src/qemu/qemu_driver.c
===================================================================
--- libvirt-3.6.0.orig/src/qemu/qemu_driver.c	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/src/qemu/qemu_driver.c	2018-01-25 09:24:55.997068377 -0500
@@ -629,6 +629,8 @@ qemuStateInitialize(bool privileged,
     gid_t run_gid = -1;
     char *hugepagePath = NULL;
     size_t i;
+    virCPUDefPtr hostCPU = NULL;
+    unsigned int microcodeVersion = 0;
 
     if (VIR_ALLOC(qemu_driver) < 0)
         return -1;
@@ -848,10 +850,15 @@ qemuStateInitialize(bool privileged,
         run_gid = cfg->group;
     }
 
+    if ((hostCPU = virCPUProbeHost(virArchFromHost())))
+        microcodeVersion = hostCPU->microcodeVersion;
+    virCPUDefFree(hostCPU);
+
     qemu_driver->qemuCapsCache = virQEMUCapsCacheNew(cfg->libDir,
                                                      cfg->cacheDir,
                                                      run_uid,
-                                                     run_gid);
+                                                     run_gid,
+                                                     microcodeVersion);
     if (!qemu_driver->qemuCapsCache)
         goto error;
 
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.2.2.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_1.2.2.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.2.2.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -111,6 +111,7 @@
   <flag name='query-cpu-definitions'/>
   <version>1002002</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>26900</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='qemu64'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.3.1.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_1.3.1.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.3.1.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -129,6 +129,7 @@
   <flag name='query-cpu-definitions'/>
   <version>1003001</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>30198</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='qemu64'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.4.2.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_1.4.2.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.4.2.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -130,6 +130,7 @@
   <flag name='query-cpu-definitions'/>
   <version>1004002</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>30915</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.5.3.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_1.5.3.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.5.3.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -142,6 +142,7 @@
   <flag name='kernel-irqchip'/>
   <version>1005003</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>47019</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.6.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_1.6.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.6.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -147,6 +147,7 @@
   <flag name='kernel-irqchip'/>
   <version>1006000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>45248</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.7.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_1.7.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_1.7.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -149,6 +149,7 @@
   <flag name='kernel-irqchip'/>
   <version>1007000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>50692</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.1.1.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.1.1.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.1.1.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -165,6 +165,7 @@
   <flag name='kernel-irqchip'/>
   <version>2001001</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>59488</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.4.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.4.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.4.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -188,6 +188,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2004000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>75653</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.5.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.5.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.5.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -194,6 +194,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2005000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>216775</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0-gicv2.aarch64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.6.0-gicv2.aarch64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0-gicv2.aarch64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -172,6 +172,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2006000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>228838</microcodeVersion>
   <package></package>
   <arch>aarch64</arch>
   <cpu type='kvm' name='pxa262'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0-gicv3.aarch64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.6.0-gicv3.aarch64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0-gicv3.aarch64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -172,6 +172,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2006000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>228838</microcodeVersion>
   <package></package>
   <arch>aarch64</arch>
   <cpu type='kvm' name='pxa262'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.6.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -204,6 +204,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2006000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>227579</microcodeVersion>
   <package></package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.7.0.s390x.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.7.0.s390x.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.7.0.s390x.xml	2018-01-25 09:24:55.997068377 -0500
@@ -134,6 +134,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2007000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>217559</microcodeVersion>
   <package></package>
   <arch>s390x</arch>
   <cpu type='kvm' name='host'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.7.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.7.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.7.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -207,6 +207,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2007000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>239276</microcodeVersion>
   <package> (v2.7.0)</package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='Opteron_G5'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.8.0.s390x.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.8.0.s390x.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.8.0.s390x.xml	2018-01-25 09:24:55.997068377 -0500
@@ -136,6 +136,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2007093</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>242460</microcodeVersion>
   <package></package>
   <arch>s390x</arch>
   <hostCPU type='kvm' model='zEC12.2-base' migratability='no'>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.8.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.8.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.8.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -209,6 +209,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2008000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>255931</microcodeVersion>
   <package> (v2.8.0)</package>
   <arch>x86_64</arch>
   <cpu type='kvm' name='host' usable='yes'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.9.0.s390x.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.9.0.s390x.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.9.0.s390x.xml	2018-01-25 09:24:55.997068377 -0500
@@ -137,6 +137,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2009000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>265878</microcodeVersion>
   <package></package>
   <arch>s390x</arch>
   <hostCPU type='kvm' model='z13.2-base' migratability='no'>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.9.0.x86_64.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.9.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.9.0.x86_64.xml	2018-01-25 09:24:55.997068377 -0500
@@ -220,6 +220,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2009000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>321194</microcodeVersion>
   <package> (v2.9.0)</package>
   <arch>x86_64</arch>
   <hostCPU type='kvm' model='base' migratability='yes'>
Index: libvirt-3.6.0/tests/qemucapabilitiestest.c
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiestest.c	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiestest.c	2018-01-25 09:24:55.997068377 -0500
@@ -61,10 +61,16 @@ testQemuCaps(const void *opaque)
                                   qemuMonitorTestGetMonitor(mon)) < 0)
         goto cleanup;
 
-    if (virQEMUCapsGet(capsActual, QEMU_CAPS_KVM) &&
-        virQEMUCapsInitQMPMonitorTCG(capsActual,
-                                     qemuMonitorTestGetMonitor(mon)) < 0)
-        goto cleanup;
+    if (virQEMUCapsGet(capsActual, QEMU_CAPS_KVM)) {
+        if (virQEMUCapsInitQMPMonitorTCG(capsActual,
+                                         qemuMonitorTestGetMonitor(mon)) < 0)
+            goto cleanup;
+
+        /* Fill microcodeVersion with a "random" value which is the file
+         * length to provide a reproducible number for testing.
+         */
+        virQEMUCapsSetMicrocodeVersion(capsActual, virFileLength(repliesFile, -1));
+    }
 
     if (!(actual = virQEMUCapsFormatCache(capsActual)))
         goto cleanup;
Index: libvirt-3.6.0/tests/qemucapsprobe.c
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapsprobe.c	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapsprobe.c	2018-01-25 09:24:55.997068377 -0500
@@ -72,7 +72,7 @@ main(int argc, char **argv)
         return EXIT_FAILURE;
 
     if (!(caps = virQEMUCapsNewForBinaryInternal(VIR_ARCH_NONE, argv[1], "/tmp",
-                                                 -1, -1, true)))
+                                                 -1, -1, 0, true)))
         return EXIT_FAILURE;
 
     virObjectUnref(caps);
Index: libvirt-3.6.0/tests/testutilsqemu.c
===================================================================
--- libvirt-3.6.0.orig/tests/testutilsqemu.c	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/testutilsqemu.c	2018-01-25 09:24:55.997068377 -0500
@@ -603,7 +603,7 @@ int qemuTestDriverInit(virQEMUDriver *dr
 
     /* Using /dev/null for libDir and cacheDir automatically produces errors
      * upon attempt to use any of them */
-    driver->qemuCapsCache = virQEMUCapsCacheNew("/dev/null", "/dev/null", 0, 0);
+    driver->qemuCapsCache = virQEMUCapsCacheNew("/dev/null", "/dev/null", 0, 0, 0);
     if (!driver->qemuCapsCache)
         goto error;
 
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0.ppc64le.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.6.0.ppc64le.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.6.0.ppc64le.xml	2018-01-25 09:38:35.766357645 -0500
@@ -167,6 +167,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2006000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>263602</microcodeVersion>
   <package></package>
   <arch>ppc64</arch>
   <cpu type='kvm' name='default'/>
Index: libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.9.0.ppc64le.xml
===================================================================
--- libvirt-3.6.0.orig/tests/qemucapabilitiesdata/caps_2.9.0.ppc64le.xml	2018-01-25 09:24:55.997068377 -0500
+++ libvirt-3.6.0/tests/qemucapabilitiesdata/caps_2.9.0.ppc64le.xml	2018-01-25 09:38:45.350368001 -0500
@@ -172,6 +172,7 @@
   <flag name='vnc-multi-servers'/>
   <version>2009000</version>
   <kvmVersion>0</kvmVersion>
+  <microcodeVersion>347135</microcodeVersion>
   <package> (v2.9.0)</package>
   <arch>ppc64</arch>
   <cpu type='kvm' name='default'/>
