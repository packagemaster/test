From 04502fd54f9bc0982c54a3ce847ff09fefd6bde7 Mon Sep 17 00:00:00 2001
From: Paolo Bonzini <pbonzini@redhat.com>
Date: Tue, 12 Dec 2017 16:23:41 +0100
Subject: [PATCH] util: introduce virHostCPUGetMicrocodeVersion

This new API reads host's CPU microcode version from /proc/cpuinfo.

Unfortunately, there is no other way of reading microcode version which
would be usable from both system and session daemon.

Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
---
 src/libvirt_private.syms |  1 +
 src/util/virhostcpu.c    | 47 +++++++++++++++++++++++++++++++++++++++++++++++
 src/util/virhostcpu.h    |  2 ++
 3 files changed, 50 insertions(+)

Index: libvirt-3.6.0/src/libvirt_private.syms
===================================================================
--- libvirt-3.6.0.orig/src/libvirt_private.syms	2018-01-25 08:32:09.644448473 -0500
+++ libvirt-3.6.0/src/libvirt_private.syms	2018-01-25 08:32:09.644448473 -0500
@@ -1788,6 +1788,7 @@ virHostCPUGetCount;
 virHostCPUGetInfo;
 virHostCPUGetKVMMaxVCPUs;
 virHostCPUGetMap;
+virHostCPUGetMicrocodeVersion;
 virHostCPUGetOnline;
 virHostCPUGetOnlineBitmap;
 virHostCPUGetPresentBitmap;
Index: libvirt-3.6.0/src/util/virhostcpu.c
===================================================================
--- libvirt-3.6.0.orig/src/util/virhostcpu.c	2018-01-25 08:32:09.644448473 -0500
+++ libvirt-3.6.0/src/util/virhostcpu.c	2018-01-25 08:32:09.644448473 -0500
@@ -1206,3 +1206,50 @@ virHostCPUGetKVMMaxVCPUs(void)
     return -1;
 }
 #endif /* HAVE_LINUX_KVM_H */
+
+
+#ifdef __linux__
+
+/*
+ * Returns 0 if the microcode version is unknown or cannot be read for
+ * some reason.
+ */
+unsigned int
+virHostCPUGetMicrocodeVersion(void)
+{
+    char *outbuf = NULL;
+    char *cur;
+    unsigned int version = 0;
+
+    if (virFileReadHeaderQuiet(CPUINFO_PATH, 4096, &outbuf) < 0) {
+        char ebuf[1024];
+        VIR_DEBUG("Failed to read microcode version from %s: %s",
+                  CPUINFO_PATH, virStrerror(errno, ebuf, sizeof(ebuf)));
+        return 0;
+    }
+
+    /* Account for format 'microcode    : XXXX'*/
+    if (!(cur = strstr(outbuf, "microcode")) ||
+        !(cur = strchr(cur, ':')))
+        goto cleanup;
+    cur++;
+
+    /* Linux places the microcode revision in a 32-bit integer, so
+     * ui is fine for us too.  */
+    if (virStrToLong_ui(cur, &cur, 0, &version) < 0)
+        goto cleanup;
+
+ cleanup:
+    VIR_FREE(outbuf);
+    return version;
+}
+
+#else
+
+unsigned int
+virHostCPUGetMicrocodeVersion(void)
+{
+    return 0;
+}
+
+#endif /* __linux__ */
Index: libvirt-3.6.0/src/util/virhostcpu.h
===================================================================
--- libvirt-3.6.0.orig/src/util/virhostcpu.h	2018-01-25 08:32:09.644448473 -0500
+++ libvirt-3.6.0/src/util/virhostcpu.h	2018-01-25 08:32:09.644448473 -0500
@@ -66,4 +66,6 @@ virBitmapPtr virHostCPUGetSiblingsList(u
 
 int virHostCPUGetOnline(unsigned int cpu, bool *online);
 
+unsigned int virHostCPUGetMicrocodeVersion(void);
+
 #endif /* __VIR_HOSTCPU_H__*/
