From 40fc85e796d061996e85849cafc04bbc92b28566 Mon Sep 17 00:00:00 2001
From: Paolo Bonzini <pbonzini@redhat.com>
Date: Tue, 12 Dec 2017 16:23:40 +0100
Subject: [PATCH] util: add virFileReadHeaderQuiet wrapper around
 virFileReadHeaderFD

Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
---
 src/libvirt_private.syms |  1 +
 src/util/virfile.c       | 19 +++++++++++++++++++
 src/util/virfile.h       |  2 ++
 3 files changed, 22 insertions(+)

Index: libvirt-3.6.0/src/libvirt_private.syms
===================================================================
--- libvirt-3.6.0.orig/src/libvirt_private.syms	2018-01-25 08:32:00.852455594 -0500
+++ libvirt-3.6.0/src/libvirt_private.syms	2018-01-25 08:32:00.848455596 -0500
@@ -1684,6 +1684,7 @@ virFileReadAll;
 virFileReadAllQuiet;
 virFileReadBufQuiet;
 virFileReadHeaderFD;
+virFileReadHeaderQuiet;
 virFileReadLimFD;
 virFileReadLink;
 virFileReadValueBitmap;
Index: libvirt-3.6.0/src/util/virfile.c
===================================================================
--- libvirt-3.6.0.orig/src/util/virfile.c	2018-01-25 08:32:00.852455594 -0500
+++ libvirt-3.6.0/src/util/virfile.c	2018-01-25 08:32:00.848455596 -0500
@@ -1356,6 +1356,25 @@ virFileReadHeaderFD(int fd, int maxlen,
 }
 
 
+int
+virFileReadHeaderQuiet(const char *path,
+                       int maxlen,
+                       char **buf)
+{
+    int fd;
+    int len;
+
+    fd = open(path, O_RDONLY);
+    if (fd < 0)
+        return -1;
+
+    len = virFileReadHeaderFD(fd, maxlen, buf);
+    VIR_FORCE_CLOSE(fd);
+
+    return len;
+}
+
+
 /* A wrapper around saferead_lim that maps a failure due to
    exceeding the maximum size limitation to EOVERFLOW.  */
 int
Index: libvirt-3.6.0/src/util/virfile.h
===================================================================
--- libvirt-3.6.0.orig/src/util/virfile.h	2018-01-25 08:32:00.852455594 -0500
+++ libvirt-3.6.0/src/util/virfile.h	2018-01-25 08:32:00.848455596 -0500
@@ -129,6 +129,8 @@ int virFileDeleteTree(const char *dir);
 
 int virFileReadHeaderFD(int fd, int maxlen, char **buf)
     ATTRIBUTE_RETURN_CHECK ATTRIBUTE_NONNULL(3);
+int virFileReadHeaderQuiet(const char *path, int maxlen, char **buf)
+    ATTRIBUTE_RETURN_CHECK ATTRIBUTE_NONNULL(1) ATTRIBUTE_NONNULL(3);
 int virFileReadLimFD(int fd, int maxlen, char **buf)
     ATTRIBUTE_RETURN_CHECK ATTRIBUTE_NONNULL(3);
 int virFileReadAll(const char *path, int maxlen, char **buf)
